Imports System.Net
Imports System.Text
Imports System.IO
Public Class xss_post_scanner
    Dim i As Integer = 0
    Dim oparam As String
    Dim x As String

    Public login As New CookieContainer

    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
        On Error Resume Next
 Dim flg As Integer = 0
        If TextBox3.Text < 1 Then
            MsgBox("Time Interval should not be less than 1 sec", vbInformation)
            flg = 1
        End If
        If Not (params.Text.Contains("[X]")) Then
            MsgBox("Replace the value of a parameter with [X] to start testing.", vbInformation)
            flg = 1
        End If
        If requrl.Text = "" Or requrl.Text = " " Then
            MsgBox("Please provide a valid URL", vbInformation)
            flg = 1
        ElseIf (Not (requrl.Text.Contains("http://") Or requrl.Text.Contains("https://"))) Then
            MsgBox("Invalid URL", vbCritical)
            flg = 1
        End If
        If flg = 0 Then
            oparam = params.Text
            Dim t As Integer = Convert.ToInt32(TextBox3.Text)
            t = t * 1000
            Timer1.Interval = t
            Timer1.Enabled = True
            Button1.Enabled = False
            Button4.Enabled = True
            Button5.Enabled = True
            Button6.Enabled = True
            Button7.Enabled = True
            'xenotix_main.add_detection_timer.Enabled = True
        End If
    End Sub

  

    Private Sub TextBox2_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TextBox2.TextChanged

    End Sub

    Private Sub post_scanner_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        On Error Resume Next
        tcount.Text = xenotix_main.payloadcounter.Text
        Button4.Enabled = False
        Button5.Enabled = False
        Button6.Enabled = False
        Button7.Enabled = False
        ListView1.ShowItemToolTips = True
        ListView1.View = View.Details
        ' Set column header
        ListView1.Columns.Clear()
        ListView1.Columns.Add("Name", 100)
        ListView1.Columns.Add("Value", 100)
    End Sub



    Private Sub Button2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button2.Click
        On Error Resume Next
        Timer1.Enabled = False
        Me.Close()
    End Sub

    Private Sub Timer1_Tick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Timer1.Tick

        Dim tparam As String = ""
        If (i <= xenotix_main.RichTextBox1.Lines.Length) Then
            If (i = xenotix_main.RichTextBox1.Lines.Length) Then
                cnt.Text = xenotix_main.RichTextBox1.Lines.Length
            Else
                cnt.Text = i + 1
            End If
            If (i = xenotix_main.RichTextBox1.Lines.Length) Then
                xenotix_main.textxss.Text = xenotix_main.RichTextBox1.Lines(i-1)
            Else
                xenotix_main.textxss.Text = xenotix_main.RichTextBox1.Lines(i)
            End If

            tparam = oparam.Replace("[X]", xenotix_main.textxss.Text)
            params.Text = tparam
            Dim postReq As HttpWebRequest = DirectCast(WebRequest.Create(requrl.Text), HttpWebRequest)
            Dim encoding As New UTF8Encoding
            Dim postData As String = params.Text
            Dim byteData As Byte() = encoding.GetBytes(postData)
            Dim tempCookies As New CookieContainer
            'cookie addition
            Dim cookie_countp As Integer = 0
            While cookie_countp < ListView1.Items.Count
                tempCookies.Add(New Uri(requrl.Text), _
            New Cookie(ListView1.Items(cookie_countp).Text, ListView1.Items(cookie_countp).SubItems(1).Text))
                cookie_countp = cookie_countp + 1
            End While


            'cookie addition
            'Proxy support
            If My.Settings.proxy_enabled = True Then

                Try
                    Dim myProxy As New WebProxy()
                    Dim newUri As New Uri("http://" & My.Settings.proxy_host & ":" & My.Settings.proxy_port)
                    myProxy.Address = newUri
                    myProxy.Credentials = New NetworkCredential(My.Settings.proxy_us, My.Settings.proxy_ps)
                    postReq.Proxy = myProxy
                Catch ex As Exception
                    MsgBox(ex.Message.ToString, vbCritical)
                End Try

            End If
            postReq.Method = "POST"
            postReq.KeepAlive = True
            postReq.CookieContainer = tempCookies
            postReq.Referer = requrl.Text
            postReq.ContentType = "application/x-www-form-urlencoded"
            postReq.UserAgent = "Mozilla/5.0 (Windows; U; Windows NT 6.1; ru; rv:1.9.2.3) Gecko/20100401 Firefox/4.0 (.NET CLR 3.5.30729)"
            postReq.ContentLength = byteData.Length
            postReq.Accept = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
            postReq.Headers.Add("Keep-Alive", "115")
            Dim req, absp As String
            Dim myUri As New Uri(requrl.Text)
            absp = myUri.AbsolutePath
            req = postReq.Method & " " & absp & " HTTP/" & postReq.ProtocolVersion.ToString & vbCrLf
            TextBox1.Text = req

            Try
                Dim postreqstream As Stream = postReq.GetRequestStream()
                postreqstream.Write(byteData, 0, byteData.Length)
                postreqstream.Close()
            Catch xx As Exception
                TextBox1.Text = xx.Message.ToString
            End Try
            'RESPONSE
            Try
                Dim myHttpWebResponse As HttpWebResponse = DirectCast(postReq.GetResponse(), HttpWebResponse)
                tempCookies.Add(myHttpWebResponse.Cookies)
                TextBox2.Text = "HTTP/" + myHttpWebResponse.ProtocolVersion.ToString + " " + Str(myHttpWebResponse.StatusCode) + " " + myHttpWebResponse.StatusDescription.ToString + ControlChars.CrLf
                Dim ii As Integer
                While ii < postReq.Headers.Count
                    TextBox1.Text += postReq.Headers.Keys(ii) + ":" + postReq.Headers(ii) + ControlChars.CrLf
                    ii = ii + 1
                End While
                TextBox1.Text += vbCrLf & params.Text & vbCrLf
                Dim ix As Integer
                While ix < myHttpWebResponse.Headers.Count
                    TextBox2.Text += myHttpWebResponse.Headers.Keys(ix) + ":" + myHttpWebResponse.Headers(ix) + ControlChars.CrLf
                    ix = ix + 1
                End While
                Dim postreqreader As New StreamReader(myHttpWebResponse.GetResponseStream, encoding)
                x = postreqreader.ReadToEnd
                bdy.Text = x
                myHttpWebResponse.Close()
                Button3.Enabled = False
            Catch xxx As Exception
                TextBox2.Text = xxx.Message.ToString
            End Try

            Try

                If xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = True Then
                    xenotix_main.web.DocumentText = x
                    xenotix_main.webkit.LoadHtml(x)
                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = False Then
                    xenotix_main.web.DocumentText = x
                    xenotix_main.webkit.LoadHtml(x)

                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = False Then
                    xenotix_main.web.DocumentText = x

                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = True Then
                    xenotix_main.web.DocumentText = x

                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = True Then

                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = False Then

                    xenotix_main.webkit.LoadHtml(x)

                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = True Then

                    xenotix_main.webkit.LoadHtml(x)
                    xenotix_main.gecko.LoadHtml(x)
                End If
            Catch p As Exception
            End Try
            i = i + 1
        Else

            Timer1.Enabled = False
            MsgBox("Test Finished!", vbInformation)
            Button1.Enabled = True
            Button4.Enabled = False
            Button5.Enabled = False
            Button6.Enabled = False
            Button7.Enabled = False
            i = 0
            cnt.Text = i
        End If

    End Sub

   

    Private Sub Button3_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button3.Click
        If requrl.Text = "" Or requrl.Text = " " Or params.Text = "" Then
            MsgBox("Please provide valid URL and POST parameter", vbInformation)

        ElseIf (Not (requrl.Text.Contains("http://") Or requrl.Text.Contains("https://"))) Then
            MsgBox("Invalid URL", vbCritical)
        Else


            Dim postReq As HttpWebRequest = DirectCast(WebRequest.Create(requrl.Text), HttpWebRequest)
            Dim encoding As New UTF8Encoding
            Dim postData As String = params.Text
            Dim byteData As Byte() = encoding.GetBytes(postData)
            Dim tempCookies As New CookieContainer
            'cookie addition
            Dim cookie_countp As Integer = 0
            While cookie_countp < ListView1.Items.Count
                tempCookies.Add(New Uri(requrl.Text), _
            New Cookie(ListView1.Items(cookie_countp).Text, ListView1.Items(cookie_countp).SubItems(1).Text))
                cookie_countp = cookie_countp + 1
            End While


            'cookie addition

            'Proxy support
            If My.Settings.proxy_enabled = True Then

                Try
                    Dim myProxy As New WebProxy()
                    Dim newUri As New Uri("http://" & My.Settings.proxy_host & ":" & My.Settings.proxy_port)
                    myProxy.Address = newUri
                    myProxy.Credentials = New NetworkCredential(My.Settings.proxy_us, My.Settings.proxy_ps)
                    postReq.Proxy = myProxy
                Catch ex As Exception
                    MsgBox(ex.Message.ToString, vbCritical)
                End Try
          
        End If
            postReq.Method = "POST"
            postReq.KeepAlive = True
            postReq.CookieContainer = tempCookies
            postReq.Referer = requrl.Text
            postReq.ContentType = "application/x-www-form-urlencoded"
            postReq.UserAgent = "Mozilla/5.0 (Windows; U; Windows NT 6.1; ru; rv:1.9.2.3) Gecko/20100401 Firefox/4.0 (.NET CLR 3.5.30729)"
            postReq.ContentLength = byteData.Length
            postReq.Accept = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
            postReq.Headers.Add("Keep-Alive", "115")
            Dim req, absp As String
            Dim myUri As New Uri(requrl.Text)
            absp = myUri.AbsolutePath
            req = postReq.Method & " " & absp & " HTTP/" & postReq.ProtocolVersion.ToString & vbCrLf
            TextBox1.Text = req

            Try
                Dim postreqstream As Stream = postReq.GetRequestStream()
                postreqstream.Write(byteData, 0, byteData.Length)
                postreqstream.Close()
            Catch xx As Exception
                TextBox1.Text = xx.Message.ToString
            End Try
            'RESPONSE
            Try
                Dim myHttpWebResponse As HttpWebResponse = DirectCast(postReq.GetResponse(), HttpWebResponse)
                tempCookies.Add(myHttpWebResponse.Cookies)
                TextBox2.Text = "HTTP/" + myHttpWebResponse.ProtocolVersion.ToString + " " + Str(myHttpWebResponse.StatusCode) + " " + myHttpWebResponse.StatusDescription.ToString + ControlChars.CrLf
                Dim ii As Integer
                While ii < postReq.Headers.Count
                    TextBox1.Text += postReq.Headers.Keys(ii) + ":" + postReq.Headers(ii) + ControlChars.CrLf
                    ii = ii + 1
                End While
                TextBox1.Text += vbCrLf & params.Text & vbCrLf
                Dim i As Integer
                While i < myHttpWebResponse.Headers.Count
                    TextBox2.Text += myHttpWebResponse.Headers.Keys(i) + ":" + myHttpWebResponse.Headers(i) + ControlChars.CrLf
                    i = i + 1
                End While
                Dim postreqreader As New StreamReader(myHttpWebResponse.GetResponseStream, encoding)
                x = postreqreader.ReadToEnd
                bdy.Text = x
                myHttpWebResponse.Close()
            Catch xxx As Exception
                TextBox2.Text = xxx.Message.ToString
            End Try

            Try

                If xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = True Then
                    xenotix_main.web.DocumentText = x
                    xenotix_main.webkit.LoadHtml(x)
                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = False Then
                    xenotix_main.web.DocumentText = x
                    xenotix_main.webkit.LoadHtml(x)

                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = False Then
                    xenotix_main.web.DocumentText = x

                ElseIf xenotix_main.ie.Checked = True And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = True Then
                    xenotix_main.web.DocumentText = x

                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = False And xenotix_main.ff.Checked = True Then

                    xenotix_main.gecko.LoadHtml(x)
                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = False Then

                    xenotix_main.webkit.LoadHtml(x)

                ElseIf xenotix_main.ie.Checked = False And xenotix_main.gc.Checked = True And xenotix_main.ff.Checked = True Then

                    xenotix_main.webkit.LoadHtml(x)
                    xenotix_main.gecko.LoadHtml(x)
                End If
            Catch p As Exception
            End Try
        End If
    End Sub

    Private Sub GroupBox1_Enter(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles GroupBox1.Enter

    End Sub

    Private Sub Button5_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button5.Click
        On Error Resume Next
        Timer1.Enabled = True
        Button5.Visible = False
        Button4.Visible = True
    End Sub

    Private Sub Button4_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button4.Click
        On Error Resume Next
        Timer1.Enabled = False
        Button4.Visible = False
        Button5.Visible = True
    End Sub

    Private Sub Button7_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button7.Click
        On Error Resume Next
        If i <= tcount.Text Then
            i = i + 1
            cnt.Text = i + 1
        End If
    End Sub

    Private Sub Button6_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button6.Click
        On Error Resume Next
        Dim x As Integer = InputBox("Enter the Payload position index", "Skip to Payload")
        If x <= tcount.Text Then
            i = x
            cnt.Text = x
        Else
            MsgBox("Invalid Payload index!", vbCritical)
        End If
    End Sub

    Private Sub Button8_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub Button8_Click_1(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button8.Click
        On Error Resume Next
        If Not (cname.Text = "") And (Not (cvalue.Text = "")) Then

            Dim TempStr(1) As String
            Dim TempNode As ListViewItem
            TempStr(0) = cname.Text
            TempStr(1) = cvalue.Text
            TempNode = New ListViewItem(TempStr)
            ListView1.Items.Add(TempNode)
            cname.Text = ""
            cvalue.Text = ""
        End If
    End Sub

    Private Sub Button9_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button9.Click
        On Error Resume Next
        For Each i As ListViewItem In ListView1.SelectedItems
            ListView1.Items.Remove(i)
        Next
    End Sub

    Private Sub Button10_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button10.Click
        On Error Resume Next
        ListView1.Items.Clear()
    End Sub

    Private Sub TextBox4_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TextBox4.TextChanged

    End Sub
End Class